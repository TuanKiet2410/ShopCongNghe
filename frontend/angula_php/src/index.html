<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AngulaPhp</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <app-root></app-root>

  


  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.12.27/build/spline-viewer.js"></script>
<div id="spline-trigger"
  style="position: fixed; bottom: 10px; right: 10px; width: 300px; height: 250px; z-index: 9998; cursor: pointer;"
  >


  <spline-viewer
    url="https://prod.spline.design/aMZ57pv4yctrR3Wm/scene.splinecode"
    loading-anim-type="spinner-small-dark"
    style="width: 250px; height: 100%; ">
    
  </spline-viewer>

  <div id="chat-tooltip" class="bg-white p-2 rounded shadow border text-start small fw-bold"
    style="position: absolute; top: -40px; left: -5cm; width: 10cm;  animation: float 3s ease-in-out infinite; display: none;">
    <div id="chat-content" class="card-body overflow-auto flex-grow-1" style="background: #f8f9fa; overflow-y: auto;min-height: 0;">
    </div>
  </div>
</div>

<div id="chat-box" class="card shadow-lg"
  style="position: fixed; top: 0; left: 0; width: 320px; height: 100vh; z-index: 9999; 
            display: flex; flex-direction: column; border-radius: 0; border-right: 1px solid #ccc;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;">

  <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center rounded-0">
    <h6 class="mb-0">üíà Nh·∫≠p l·ªánh cho AI</h6>
    <button id="close-chat" class="btn-close btn-close-white"></button>
  </div>

  <div id="chat-content2" class="card-body overflow-auto flex-grow-1" style="background: #f8f9fa;">
    <div class="text-center text-muted small my-2">L·ªãch s·ª≠ tr√≤ chuy·ªán</div>
  </div>

  <div class="card-footer p-3 bg-white">
    <div class="input-group">
      <input type="text" id="user-input" class="form-control" placeholder="Nh·∫≠p y√™u c·∫ßu..." aria-label="Message">
      <button class="btn btn-dark" id="send-btn">G·ª≠i</button>
    </div>
    <small class="text-muted fst-italic mt-2 d-block text-center" style="font-size: 11px;">
      B·∫•m Enter ƒë·ªÉ g·ª≠i v√† ƒë√≥ng khung chat
    </small>
  </div>
</div>

<style>
  @keyframes float {
    0% {
      transform: translateY(0px);
    }

    50% {
      transform: translateY(-10px);
    }

    100% {
      transform: translateY(0px);
    }
  }

  /* ·∫®n logo Spline (n·∫øu mu·ªën hack m·ªôt ch√∫t, nh∆∞ng b·∫£n free v·∫´n c√≥ th·ªÉ hi·ªán) */
  spline-viewer::part(logo) {
    display: none;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatBtn = document.getElementById('spline-trigger');
    const chatBox = document.getElementById('chat-box');
    const closeChat = document.getElementById('close-chat');
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const chatContent = document.getElementById('chat-content');
    const chatContent2 = document.getElementById('chat-content2');
    const tooltip = document.getElementById('chat-tooltip');

    // --- 1. H√†m M·ªü Sidebar (T√°ch ra ƒë·ªÉ d√πng chung) ---
    function openSidebar() {
      // Ch·ªâ m·ªü n·∫øu n√≥ ƒëang ƒë√≥ng
      if (chatBox.style.transform !== "translateX(0px)") {
        chatBox.style.transform = "translateX(0)";
        tooltip.style.display = 'none';
        setTimeout(() => userInput.focus(), 100);
      } else {
        // N·∫øu ƒëang m·ªü r·ªìi th√¨ focus lu√¥n
        userInput.focus();
      }
    }

    // --- 2. H√†m ƒê√≥ng Sidebar ---
    // --- 2. H√†m ƒê√≥ng Sidebar ---
    function closeSidebar() {
      chatBox.style.transform = "translateX(-100%)";

      // üî• QUAN TR·ªåNG: B·ªè focus kh·ªèi √¥ nh·∫≠p li·ªáu
      // ƒê·ªÉ l·∫ßn sau b·∫°n g√µ ph√≠m, n√≥ s·∫Ω t√≠nh l√† g√µ ngo√†i m√†n h√¨nh -> K√≠ch ho·∫°t m·ªü l·∫°i
      userInput.blur();
    }

    // S·ª± ki·ªán Click v√†o con 3D
    chatBtn.addEventListener('click', openSidebar);

    // S·ª± ki·ªán Click n√∫t ƒë√≥ng
    closeChat.addEventListener('click', closeSidebar);

    // --- 3. S·ª∞ KI·ªÜN G√ï PH√çM T·ª∞ ƒê·ªòNG M·ªû ---
    document.addEventListener('keydown', function(event) {
      const activeTag = document.activeElement.tagName.toLowerCase();

      // N·∫øu ƒëang g√µ v√†o √¥ input/textarea n√†o ƒë√≥ th√¨ b·ªè qua
      if (activeTag === 'input' || activeTag === 'textarea') {
        return;
      }

      // N·∫øu ph√≠m l√† ch·ªØ/s·ªë v√† kh√¥ng ph·∫£i ph√≠m ch·ª©c nƒÉng
      if (event.key.length === 1 && !event.ctrlKey && !event.altKey && !event.metaKey) {
        openSidebar();
        // (T√πy ch·ªçn) Focus xong th√¨ ƒëi·ªÅn lu√¥n k√Ω t·ª± v·ª´a g√µ v√†o ƒë·ªÉ ƒë·ª° m·∫•t ch·ªØ ƒë·∫ßu ti√™n
        // setTimeout(() => {
        //     userInput.value += event.key;
        // }, 110); 
      }
    });

    // --- 4. G·ª≠i tin nh·∫Øn ---
    function sendMessage() {
      const message = userInput.value.trim();
      if (message === "") return;

      // --- G·ªåI H√ÄM RESET NGAY T·∫†I ƒê√ÇY ---
      resetSpline();
      // ----------------------------------

      appendMessage('user', message);
      userInput.value = '';

      // ƒê√≥ng chat v√† hi·ªán tooltip b√™n ph·∫£i
      closeSidebar();

      tooltip.style.display = 'block';
      tooltip.style.width = 'auto';
      tooltip.style.maxWidth = '250px';
      tooltip.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang h·ªèi s·∫øp...';

      fetch('http://localhost/DA_CD_PHP/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message
          })
        })
        .then(response => response.json())
        .then(data => {
          appendMessage('bot', data.reply);
          typeWriterEffect(data.reply, tooltip);
        })
        .catch(error => {
          tooltip.innerHTML = '‚ùå L·ªói k·∫øt n·ªëi!';
        });
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    function typeWriterEffect(text, element) {
      element.innerHTML = '';
      let i = 0;
      let speed = 30;

      function type() {
        if (i < text.length) {
          element.innerHTML += text.charAt(i);
          i++;
          setTimeout(type, speed);
        }
      }
      type();
    }

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = sender === 'user' ? 'd-flex justify-content-end mb-2' : 'd-flex justify-content-start mb-2';
      const contentDiv = document.createElement('div');
      contentDiv.className = sender === 'user' ? 'bg-dark text-white p-2 rounded shadow-sm' : 'bg-white text-dark p-2 rounded shadow-sm border';
      contentDiv.style.maxWidth = '80%';
      contentDiv.innerText = text;
      div.appendChild(contentDiv);
      chatContent.appendChild(div);
      chatContent.scrollTop = chatContent.scrollHeight;
      chatContent2.appendChild(div);
      chatContent2.scrollTop = chatContent2.scrollHeight;
    }
  });

  //t·∫°m th·ªùi ƒë√°nh l·ª´a cho n√≥ ƒë√πng nh√¨n theo con tr·ªè chu·ªôt
  // L·∫•y th·∫ª Spline Viewer
  const splineViewer = document.querySelector('spline-viewer');

  // --- H√†m Reset v·ªã tr√≠ 3D (Phi√™n b·∫£n n√¢ng cao) ---
    function resetSpline() {
        const viewer = document.querySelector('spline-viewer');
        
        if (viewer && viewer.shadowRoot) {
            // 1. T√¨m c√°i Canvas v·∫Ω 3D b√™n trong th·∫ª Spline
            const canvas = viewer.shadowRoot.querySelector('canvas');
            
            if (canvas) {
                // 2. T·∫°o m·ªôt s·ª± ki·ªán gi·∫£: "Chu·ªôt ƒë√£ r·ªùi ƒëi" (mouseout)
                const mouseOutEvent = new MouseEvent('mouseout', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                
                // 3. B·∫Øn s·ª± ki·ªán n√†y th·∫≥ng v√†o canvas
                canvas.dispatchEvent(mouseOutEvent);
                
                // 4. B·∫Øn th√™m s·ª± ki·ªán mouseleave cho ch·∫Øc ƒÉn
                const mouseLeaveEvent = new MouseEvent('mouseleave', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                canvas.dispatchEvent(mouseLeaveEvent);
            }
        }
    }
</script>
</body>
</html>
